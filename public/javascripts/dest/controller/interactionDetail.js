define(function(){return function($scope,$rootScope,$location,Tool,Ajax){$scope.post={},$scope.replyMess={},$scope.showReplyInputId=null,$scope.showPostinput=!1,$scope.messageId=null,$scope.replyId=null,$scope.inputStyle="输入你的回复...",$scope.noProduct=!1,$scope.noProductText="",$scope.postId="",$scope.follow={hasFollow:!1,followText:"关注"},$scope.queryParams={id:"",pageRows:10,currentPage:1},$scope.imgStyle={width:screen.width},$scope.swiperParams={hasSwiper:!1,showBefore:!1,showAfter:!1},$scope.init=function(){$rootScope.hasBgColor=!1,$scope.getQueryString(),$scope.queryPost(),$scope.queryMessage(),$scope.initSwiper()},$scope.initSwiper=function(){new Swiper("#swiper1",{loop:!1,autoplayDisableOnInteraction:!1,observeParents:!0,observer:!0}),new Swiper("#swiper2",{loop:!1,autoplayDisableOnInteraction:!1,observeParents:!0,observer:!0})},$scope.switchSwiper=function(item,has){$scope.swiperParams.hasSwiper=has,"before"===item&&($scope.swiperParams.showBefore=has),"after"===item&&($scope.swiperParams.showAfter=has)},$scope.getQueryString=function(){$location.search().id?($scope.postId=$location.search().id,$scope.queryParams.id=$location.search().id):Tool.changeRoute("/interaction")},window.onscroll=function(){if(!$rootScope.loading&&!$scope.noProduct){var body=document.body,html=document.documentElement,height=Math.max(body.scrollHeight,body.offsetHeight,html.clientHeight,html.scrollHeight,html.offsetHeight);height>window.innerHeight&&height-window.scrollY-window.innerHeight<100&&$scope.loadNext()}},$scope.loadNext=function(){$scope.queryParams.currentPage++,$scope.queryMessage()},$scope.queryPost=function(){var obj={id:$scope.postId};Tool.checkLogin()&&(Tool.loadUserinfo(),obj.accessToken=Tool.userInfo.accessToken),Ajax.post({url:Tool.host+"/wx/post/postDetail",params:obj}).then(function(data){0==data.code?($scope.post=data.data,null===$scope.post.faceImage&&""===$scope.post.faceImage||($scope.post.faceImage="https://biz.uokang.com/"+$scope.post.faceImage),$scope.post.list1.length>0?$scope.post.hasList1=!0:$scope.post.hasList1=!1,$scope.post.list2.length>0?$scope.post.hasList2=!0:$scope.post.hasList2=!1,1===data.data.focusState&&($scope.follow.hasFollow=!0,$scope.follow.followText="已关注")):Tool.alert(data.message)})["catch"](function(){Tool.alert("帖子信息加载失败!")})["finally"](function(){$rootScope.loading=!1})},$scope.queryMessage=function(){Ajax.post({url:Tool.host+"/wx/post/postMessage",params:$scope.queryParams}).then(function(data){0==data.code?(data.data.commentList.length<1&&($scope.noProduct=!0),$scope.mergeMessage(data.data),$scope.replyMess.commentList?$scope.replyMess.commentList=$scope.replyMess.commentList.concat(data.data.commentList):$scope.replyMess=data.data):Tool.alert("连接数据失败，请稍后再试!")})["catch"](function(){Tool.alert("连接数据失败，请稍后再试!")})["finally"](function(){$rootScope.loading=!1})},$scope.mergeMessage=function(post){post.message="";var comment=post.commentList;if($scope.replyMess.commentList)var counts=$scope.replyMess.commentList.length;else var counts=0;if(comment.length>0)for(var outIndex in comment){var reply=comment[outIndex];if(reply.count=counts+1,counts++,reply.hasReplyInput=!1,reply.message="",reply.createDateStr&&(reply.createDateStr=reply.createDateStr.trim(),reply.createDateStr=reply.createDateStr.slice(5,10)),parseInt(reply.praiseNum)<1&&(reply.praiseNum="点赞"),reply.repliesMessageList.length>0){reply.hasReply=!0;var replyList=reply.repliesMessageList;for(var inIndex in replyList){var replyListItem=replyList[inIndex];""==replyListItem.replyName||null==replyListItem.replyName?replyListItem.isReply=!1:replyListItem.isReply=!0}}else reply.hasReply=!1}},$scope.checkLogin=function(){return Tool.checkLogin()?(Tool.loadUserinfo(),!0):(Tool.comfirm("请先登录！",function(){$rootScope.hasTip=!1,Tool.changeRoute("/login")}),!1)},$scope.thumb=function(id,flag){if($scope.checkLogin()){var reply="";if(0==flag)reply=$scope.post;else for(var index in $scope.replyMess.commentList)$scope.replyMess.commentList[index].id==id&&(reply=$scope.replyMess.commentList[index]);Ajax.post({url:Tool.host+"/wx/post/thumbUp",params:{postId:id,flag:flag},headers:{accessToken:Tool.userInfo.accessToken}}).then(function(data){0==data.code?reply.praiseNum=data.data:1==data.code&&Tool.alert(data.message)})["catch"](function(){Tool.alert("连接数据失败，请稍后再试!")})["finally"](function(){$rootScope.loading=!1})}},$scope.showReplyInput=function(id,replyId,replyName){if($scope.checkLogin()&&$scope.showReplyInputId!=id){var post=$scope.replyMess;if($scope.messageId=id,replyId&&replyId!=Tool.userInfo.id&&($scope.replyId=replyId),null==$scope.showReplyInputId)for(var index in post.commentList)post.commentList[index].id==id&&(post.commentList[index].hasReplyInput=!0,$scope.inputStyle="输入你的回复...",replyId&&replyId!=Tool.userInfo.id&&($scope.inputStyle="回复 "+replyName+": "));else for(var index in post.commentList)post.commentList[index].id==id&&(post.commentList[index].hasReplyInput=!0,$scope.inputStyle="输入你的回复...",replyId&&replyId!=Tool.userInfo.id&&($scope.inputStyle="回复 "+replyName+": ")),post.commentList[index].id==$scope.showReplyInputId&&(post.commentList[index].hasReplyInput=!1);$scope.showReplyInputId=id}},$scope.showPostInput=function(){$scope.checkLogin()&&0==$scope.showPostinput&&($scope.showPostinput=!0)},$scope.hidePostInput=function(){1==$scope.showPostinput&&($scope.showPostinput=!1,$scope.post.message="")},$scope.hideReplyInput=function(id){var post=$scope.replyMess;for(var index in post.commentList)post.commentList[index].id==id&&(post.commentList[index].hasReplyInput=!1,post.commentList[index].message="",$scope.inputStyle="输入你的回复...");$scope.showReplyInputId&&($scope.showReplyInputId=null),$scope.messageId&&($scope.messageId=null),$scope.replyId&&($scope.replyId=null)},$scope.sendPost=function(content){if(""==content||null==content)Tool.alert("消息为空!");else{var params={postId:$scope.post.id,replyState:0,content:content,userId:Tool.userInfo.id};Ajax.post({url:Tool.host+"/wx/repliesMessage/addRepliesMessage",params:params,headers:{accessToken:Tool.userInfo.accessToken}}).then(function(data){0==data.code?($scope.hidePostInput(),data.data.count=$scope.replyMess.commentList.length+1,$scope.mergeNewReply(data.data),$scope.replyMess.commentList.push(data.data)):Tool.alert(data.message)})["catch"](function(){Tool.alert("连接数据失败，请稍后重试!")})["finally"](function(){$rootScope.loading=!1})}},$scope.mergeNewReply=function(reply){if(null===reply.userImage||""===reply.userImage){var user=Tool.getLocal("user");"男"===user.sex||""===user.sex||null===user.sex?reply.userImage="../contents/img/men-head.png":reply.userImage="../contents/img/women-head.png"}},$scope.sendReply=function(content,id){if(""==content||null==content)Tool.alert($scope,"消息为空！");else{var params={postId:$scope.post.id,replyState:1,content:content,userId:Tool.userInfo.id,messageId:$scope.messageId};$scope.replyId&&(params.replyId=$scope.replyId),Ajax.post({url:Tool.host+"/wx/repliesMessage/addRepliesMessage",params:params,headers:{accessToken:Tool.userInfo.accessToken}}).then(function(data){if(0==data.code){$scope.showReplyInputId=null,$scope.messageId=null,$scope.replyId=null,$scope.hideReplyInput(id);for(var index in $scope.replyMess.commentList)if($scope.replyMess.commentList[index].id==id)return""==data.data.replyName||null==data.data.replyName?data.data.isReply=!1:data.data.isReply=!0,$scope.replyMess.commentList[index].hasReply=!0,void $scope.replyMess.commentList[index].repliesMessageList.push(data.data)}else Tool.alert(data.message)})["catch"](function(){Tool.alert("连接数据失败，请稍后重试!")})["finally"](function(){$rootScope.loading=!1})}},$scope.clickFollow=function(){Tool.checkLogin()?$scope.follow.hasFollow?$scope.cacelFollow():$scope.tofollow():Tool.comfirm("请先登录!",function(){$rootScope.hasTip=!1,Tool.changeRoute("/login")})},$scope.tofollow=function(){Ajax.post({url:Tool.host+"/wx/post/focus",params:{flag:1,userId:$scope.post.userId},headers:{accessToken:Tool.userInfo.accessToken}}).then(function(data){0==data.code?($scope.follow.hasFollow=!0,$scope.follow.followText="已关注"):Tool.alert("关注失败，稍后再试!")})["catch"](function(){Tool.alert("连接数据失败，请稍后再试!")})["finally"](function(){$rootScope.loading=!1})},$scope.cacelFollow=function(){Ajax.post({url:Tool.host+"/wx/post/cacelFocus",params:{flag:1,userId:$scope.post.userId},headers:{accessToken:Tool.userInfo.accessToken}}).then(function(data){0==data.code?($scope.follow.hasFollow=!1,$scope.follow.followText="关注"):Tool.alert("取消关注失败，稍后再试!")})["catch"](function(){Tool.alert("连接数据失败，稍后再试!")})["finally"](function(){$rootScope.loading=!1})},$scope.goDoctor=function(id){Tool.changeRoute("/doctor/detail","id="+id)},$scope.goProduct=function(productId,hospitalId){Tool.changeRoute("/product/detail","flag=1&productId="+productId+"&hospitalId="+hospitalId)}}});