define(["require","exports","Swiper"],function(require,exports,Swiper){"use strict";function interactionDetail($scope,$rootScope,$location,ToolService,AjaxService){$scope.post={},$scope.replyMess={},$scope.showReplyInputId=null,$scope.showPostinput=!1,$scope.messageId=null,$scope.replyId=null,$scope.inputStyle="输入你的回复...",$scope.postId="",$scope.follow={hasFollow:!1,followText:"关注"},$scope.queryParams={id:"",pageRows:10,currentPage:1},$scope.imgStyle={width:screen.width},$scope.swiperParams={hasSwiper:!1,showBefore:!1,showAfter:!1};var initSwiper=function(){new Swiper("#swiper1",{loop:!1,autoplayDisableOnInteraction:!1,observeParents:!0,observer:!0}),new Swiper("#swiper2",{loop:!1,autoplayDisableOnInteraction:!1,observeParents:!0,observer:!0})};$scope.switchSwiper=function(item,has){$scope.swiperParams.hasSwiper=has,"before"===item&&($scope.swiperParams.showBefore=has),"after"===item&&($scope.swiperParams.showAfter=has)};var getQueryString=function(){$location.search().id?($scope.postId=$location.search().id,$scope.queryParams.id=$location.search().id):ToolService.changeRoute("/interaction")},loadNext=function(){$scope.queryParams.currentPage++,queryMessage()},queryPost=function(){var obj={id:$scope.postId,accessToken:""};ToolService.checkLogin()?(ToolService.loadUser(),obj.accessToken=ToolService.user.accessToken):obj.accessToken=null,AjaxService.post({url:ToolService.host+"/wx/post/postDetail",data:obj}).then(function(data){0==data.code?($scope.post=data.data,null===$scope.post.faceImage&&""===$scope.post.faceImage||($scope.post.faceImage="https://biz.uokang.com/"+$scope.post.faceImage),$scope.post.list1.length>0?$scope.post.hasList1=!0:$scope.post.hasList1=!1,$scope.post.list2.length>0?$scope.post.hasList2=!0:$scope.post.hasList2=!1,1===data.data.focusState&&($scope.follow.hasFollow=!0,$scope.follow.followText="已关注")):ToolService.alert(data.message)})},queryMessage=function(){AjaxService.post({url:ToolService.host+"/wx/post/postMessage",data:$scope.queryParams}).then(function(data){0==data.code?(data.data.commentList.length<1&&($rootScope.followTip.has=!0),mergeMessage(data.data),$scope.replyMess.commentList?$scope.replyMess.commentList=$scope.replyMess.commentList.concat(data.data.commentList):$scope.replyMess=data.data):ToolService.alert("连接数据失败，请稍后再试!")})},mergeMessage=function(post){post.message="";var comment=post.commentList;if($scope.replyMess.commentList)var counts=$scope.replyMess.commentList.length;else var counts=0;if(comment.length>0)for(var outIndex in comment){var reply=comment[outIndex];if(reply.count=counts+1,counts++,reply.hasReplyInput=!1,reply.message="",reply.createDateStr&&(reply.createDateStr=reply.createDateStr.trim(),reply.createDateStr=reply.createDateStr.slice(5,10)),parseInt(reply.praiseNum)<1&&(reply.praiseNum="点赞"),reply.repliesMessageList.length>0){reply.hasReply=!0;var replyList=reply.repliesMessageList;for(var inIndex in replyList){var replyListItem=replyList[inIndex];""==replyListItem.replyName||null==replyListItem.replyName?replyListItem.isReply=!1:replyListItem.isReply=!0}}else reply.hasReply=!1}},checkLogin=function(){return ToolService.checkLogin()?(ToolService.loadUser(),!0):(ToolService.comfirm("请先登录！",function(){$rootScope.followTip.has=!1,ToolService.changeRoute("/login")}),!1)};$scope.thumb=function(id,flag){if(checkLogin()){var reply="";if(0==flag)reply=$scope.post;else for(var index in $scope.replyMess.commentList)$scope.replyMess.commentList[index].id==id&&(reply=$scope.replyMess.commentList[index]);AjaxService.post({url:ToolService.host+"/wx/post/thumbUp",data:{postId:id,flag:flag},headers:{accessToken:ToolService.user.accessToken}}).then(function(data){0==data.code?reply.praiseNum=data.data:1==data.code&&ToolService.alert(data.message)})}},$scope.showReplyInput=function(id,replyId,replyName){if(checkLogin()&&$scope.showReplyInputId!=id){var post=$scope.replyMess;if($scope.messageId=id,replyId&&replyId!=ToolService.user.id&&($scope.replyId=replyId),null==$scope.showReplyInputId)for(var index in post.commentList)post.commentList[index].id==id&&(post.commentList[index].hasReplyInput=!0,$scope.inputStyle="输入你的回复...",replyId&&replyId!=ToolService.user.id&&($scope.inputStyle="回复 "+replyName+": "));else for(var index in post.commentList)post.commentList[index].id==id&&(post.commentList[index].hasReplyInput=!0,$scope.inputStyle="输入你的回复...",replyId&&replyId!=ToolService.user.id&&($scope.inputStyle="回复 "+replyName+": ")),post.commentList[index].id==$scope.showReplyInputId&&(post.commentList[index].hasReplyInput=!1);$scope.showReplyInputId=id}},$scope.showPostInput=function(){checkLogin()&&0==$scope.showPostinput&&($scope.showPostinput=!0)},$scope.hidePostInput=function(){1==$scope.showPostinput&&($scope.showPostinput=!1,$scope.post.message="")},$scope.hideReplyInput=function(id){var post=$scope.replyMess;for(var index in post.commentList)post.commentList[index].id==id&&(post.commentList[index].hasReplyInput=!1,post.commentList[index].message="",$scope.inputStyle="输入你的回复...");$scope.showReplyInputId&&($scope.showReplyInputId=null),$scope.messageId&&($scope.messageId=null),$scope.replyId&&($scope.replyId=null)},$scope.sendPost=function(content){if(""==content||null==content)ToolService.alert("消息为空!");else{var params={postId:$scope.post.id,replyState:0,content:content,userId:ToolService.user.id};AjaxService.post({url:ToolService.host+"/wx/repliesMessage/addRepliesMessage",data:params,headers:{accessToken:ToolService.user.accessToken}}).then(function(data){0==data.code?($scope.hidePostInput(),data.data.count=$scope.replyMess.commentList.length+1,$scope.mergeNewReply(data.data),$scope.replyMess.commentList.push(data.data)):ToolService.alert(data.message)})}},$scope.mergeNewReply=function(reply){if(null===reply.userImage||""===reply.userImage){var user=ToolService.getLocal("user");"男"===user.sex||""===user.sex||null===user.sex?reply.userImage="../contents/img/men-head.png":reply.userImage="../contents/img/women-head.png"}},$scope.sendReply=function(content,id){if(""==content||null==content)ToolService.alert("消息为空！");else{var params={postId:$scope.post.id,replyState:1,content:content,userId:ToolService.user.id,messageId:$scope.messageId};$scope.replyId&&(params.replyId=$scope.replyId),AjaxService.post({url:ToolService.host+"/wx/repliesMessage/addRepliesMessage",data:params,headers:{accessToken:ToolService.user.accessToken}}).then(function(data){if(0==data.code){$scope.showReplyInputId=null,$scope.messageId=null,$scope.replyId=null,$scope.hideReplyInput(id);for(var index in $scope.replyMess.commentList)if($scope.replyMess.commentList[index].id==id)return""==data.data.replyName||null==data.data.replyName?data.data.isReply=!1:data.data.isReply=!0,$scope.replyMess.commentList[index].hasReply=!0,void $scope.replyMess.commentList[index].repliesMessageList.push(data.data)}else ToolService.alert(data.message)})}},$scope.clickFollow=function(){ToolService.checkLogin()?$scope.follow.hasFollow?$scope.cacelFollow():$scope.tofollow():ToolService.comfirm("请先登录!",function(){$rootScope.messageTip.has=!1,ToolService.changeRoute("/login")})},$scope.tofollow=function(){AjaxService.post({url:ToolService.host+"/wx/post/focus",data:{flag:1,userId:$scope.post.userId},headers:{accessToken:ToolService.user.accessToken}}).then(function(data){0==data.code?($scope.follow.hasFollow=!0,$scope.follow.followText="已关注"):ToolService.alert("关注失败，稍后再试!")})},$scope.cacelFollow=function(){AjaxService.post({url:ToolService.host+"/wx/post/cacelFocus",data:{flag:1,userId:$scope.post.userId},headers:{accessToken:ToolService.user.accessToken}}).then(function(data){0==data.code?($scope.follow.hasFollow=!1,$scope.follow.followText="关注"):ToolService.alert("取消关注失败，稍后再试!")})},$scope.goDoctor=function(id){ToolService.changeRoute("/doctor/detail","id="+id)},$scope.goProduct=function(productId,hospitalId){ToolService.changeRoute("/product/detail","flag=1&productId="+productId+"&hospitalId="+hospitalId)},ToolService.reset(),getQueryString(),queryPost(),queryMessage(),initSwiper(),ToolService.onWindowListen(loadNext)}return interactionDetail});