define(function(){return function($scope,$rootScope,$location,Tool,Ajax){$scope.productId=null,$scope.hospitalId=null,$scope.product=null,$scope.productItem=[],$scope.schedules=[],$scope.hospital=null,$scope.hospitalImg=null,$scope.noSchedule=!1,$scope.noSelectTime=!1,$scope.scheduleParams={},$scope.filterParams={product:{has:!0},hospital:{has:!1},notice:{has:!1}},$scope.order={hospitalId:"",doctorId:"",productId:"",scheduleId:"",doctorName:"",treatmentTime:"",hospitalName:"",hospitalAddress:"",preferPrice:"",productName:"",flag:1,dealMoney:"",payMoney:"",realMoney:"",giftMoney:"",code:null,discountid:null},$scope.init=function(){Tool.noWindowListen(),$scope.loadParams(),$scope.loadProduct(),$scope.loadHospital(),$scope.loadHopitalImg(),$scope.loadProductItem(),$scope.loadSchedule()},$scope["switch"]=function(item){Tool.select(item,$scope.filterParams)},$scope.back=function(){window.history.back()},$scope.loadParams=function(){$location.search().productId&&($scope.productId=$location.search().productId,$scope.order.productId=$scope.productId),$location.search().hospitalId&&($scope.hospitalId=$location.search().hospitalId,$scope.order.hospitalId=$scope.hospitalId)},$scope.loadSchedule=function(){Ajax.post({url:Tool.host+"/wx/schedule/querybyhospitalid",params:{hospitalId:$scope.hospitalId}}).then(function(data){data.length>0?($scope.mergeSchedule(data),$scope.schedules=data):$scope.noSchedule=!0})["catch"](function(){Tool.alert("加载排班信息失败，请稍后再试!")})["finally"](function(){$rootScope.loading=!1})},$scope.mergeSchedule=function(items){for(var index in items){var item=items[index];0==index?($scope.scheduleParams[item.scheduleid]={has:!0,val:item.dateStr},$scope.order.treatmentTime=item.dateStr,$scope.order.scheduleId=item.scheduleid):$scope.scheduleParams[item.scheduleid]={has:!1,val:item.dateStr}}},$scope.loadProduct=function(){Ajax.post({url:Tool.host+"/wx/product/packagedetal",params:{packageid:$scope.productId}}).then(function(data){0==data.code?($scope.mergeProduct(data.data),$scope.product=data.data,$scope.order.productName=$scope.product.title,$scope.order.preferPrice=$scope.product.preferPrice+$scope.product.preferPriceType):Tool.alert("加载套餐信息失败，请稍后再试!")})["catch"](function(){Tool.alert("加载套餐信息失败，请稍后再试!")})["finally"](function(){$rootScope.loading=!1})},$scope.mergeProduct=function(item){null!=item.priceunit&&""!=item.priceunit?item.preferPriceType=item.pricetype+"/"+item.priceunit:item.preferPriceType=item.pricetype,""!=item.smallImg&&null!=item.smallImg||(item.smallImg="../contents/img/p_default.png")},$scope.loadProductItem=function(){Ajax.post({url:Tool.host+"/wx/product/packagedetalItem",params:{packageid:$scope.productId}}).then(function(data){$scope.productItem=data})["catch"](function(){Tool.alert("加载体检项目失败，请稍后再试!")})["finally"](function(){$rootScope.loading=!1})},$scope.loadHospital=function(){Ajax.post({url:Tool.host+"/wx/product/hospitalbyid",params:{id:$scope.hospitalId}}).then(function(data){0==data.code&&($scope.mergeHospital(data.data),$scope.hospital=data.data,$scope.order.hospitalAddress=$scope.hospital.address,$scope.order.hospitalName=$scope.hospital.name)})["catch"](function(){Tool.alert("加载医院信息失败，请稍后再试!")})["finally"](function(){$rootScope.loading=!1})},$scope.mergeHospital=function(item){""!=item.logo&&null!=item.logo||(item.logo="../contents/img/p_default.png")},$scope.loadHopitalImg=function(){Ajax.post({url:Tool.host+"/wx/image/querybymainid",params:{type:"HOSPITAL",mainId:$scope.hospitalId}}).then(function(data){""==data[0].url|null==data[0].url&&(data[0].url="../contents/img/p_default.png"),$scope.hospitalImg=data[0].url})},$scope.selectTimeBtn=function(){$scope.noSchedule||($scope.hasSelectTime=!0)},$scope.cancelTime=function(){$scope.hasSelectTime=!1},$scope.selectTime=function(id){$scope.noSchedule||(Tool.select(id,$scope.scheduleParams),$scope.order.treatmentTime=$scope.scheduleParams[id].val,$scope.order.scheduleId=id)},$scope.detail=function(){Tool.checkLogin()?Tool.isUserInfoComplete()?(Tool.loadUserinfo(),Ajax.post({url:Tool.host+"/wx/order/checkCodeMoney",params:{productId:$scope.order.productId},headers:{accessToken:Tool.userInfo.accessToken}}).then(function(data){$scope.order.dealMoney=data.dealMoney,$scope.order.payMoney=data.payMoney,$scope.order.realMoney=data.realMoney,$scope.order.giftMoney=data.giftMoney,parseFloat($scope.order.giftMoney)<=0&&($scope.order.flag=null),Tool.setSession("makeorder",$scope.order),Tool.changeRoute("/makeorder")})["catch"](function(){Tool.alert($scope,"加载App付款金额失败!")})["finally"](function(){$rootScope.loading=!1})):Tool.comfirm("请完善个人信息!",function(){$rootScope.hasTip=!1,Tool.changeRoute("/user/userinfo")}):Tool.comfirm("请先登录并完善个人信息!",function(){$rootScope.hasTip=!1,Tool.changeRoute("/login")})}}});