define(["require","exports"],function(require,exports){"use strict";function productDetail($scope,$rootScope,$location,$http,ToolService,AjaxService){$scope.selectTime=!1,$scope.hasDoctor=!1,$scope.noSelectTime=!0,$scope.hasDocSchedule="",$scope.selectDoc="",$scope.hosId,$scope.proId,$scope.hasDiscount=!1,$scope.productInfo,$scope.hospitalInfo,$scope.doctorInfo=[],$scope.activityp="",$scope.follow={hasFollow:!1,followText:"关注"},$scope.scheduleInfo=[],$scope.scheduleParams={},$scope.order={hospitalId:"",doctorId:"",productId:"",scheduleId:"",doctorName:"",treatmentTime:"",hospitalName:"",hospitalAddress:"",preferPrice:"",productName:"",flag:null,dealMoney:"",payMoney:"",realMoney:"",giftMoney:"",code:null,discountid:null};var loadQueryParams=function(){$scope.hosId=$location.search().hospitalId,$scope.proId=$location.search().productId,$location.search().flag&&($scope.order.flag=$location.search().flag),$location.search().discountid&&($scope.order.discountid=$location.search().discountid,$scope.hasDiscount=!0),$location.search().code&&($scope.order.code=$location.search().code),$location.search().activityp&&($scope.activityp=$location.search().activityp)};$scope.back=function(){window.history.back()};var queryProduct=function(){var obj={productId:$scope.proId};ToolService.checkLogin()&&(ToolService.loadUser(),obj.accessToken=ToolService.user.accessToken),AjaxService.post({url:ToolService.host+"/wx/product/querybyid",data:obj}).then(function(data){1===data.data.focusState&&($scope.follow.hasFollow=!0,$scope.follow.followText="已关注"),$scope.mergeProdcut(data.data),$scope.productInfo=data.data,$scope.order.productName=$scope.productInfo.title,$scope.order.preferPrice="￥"+$scope.productInfo.preferPrice+$scope.productInfo.preferPriceType})},queryProductImg=function(){AjaxService.post({url:ToolService.host+"/wx/image/querybymainid",data:{type:"PRODUCT",mainId:$scope.proId}}).then(function(data){data.length>0&&($scope.productImg=data)})},queryHospital=function(){AjaxService.post({url:ToolService.host+"/wx/hospital/querybyid",data:{id:$scope.hosId}}).then(function(data){$scope.hospitalInfo=data,$scope.order.hospitalName=data.name,$scope.order.hospitalAddress=data.address})},queryHospitalImg=function(){AjaxService.post({url:ToolService.host+"/wx/image/querybymainid",data:{type:"HOSPITAL",mainId:$scope.hosId}}).then(function(data){data.length>0&&($scope.hospitalImg=data)})},queryDoctor=function(){AjaxService.post({url:ToolService.host+"/wx/doctor/queryscheduledoctorbyproductid",data:{productId:$scope.proId}}).then(function(data){data.list.length>0&&($scope.hasDoctor=!0,$scope.doctorInfo=data.list,$scope.doctorInfo.forEach(function(item){""!=item.score&&null!=item.score||(item.score="暂无评"),item.selectTimeValue="请选择",item.hasSelecTimeValue=!1}))})},queryDoctorSchedule=function(docId){$scope.hasDocSchedule==docId?$scope.selectTime=!0:AjaxService.post({url:ToolService.host+"/wx/schedule/querybydoctorid",data:{doctorId:docId}}).then(function(data){$scope.mergeSchedule(data),$scope.scheduleInfo=data,$scope.loading=!1,$scope.selectTime=!0,$scope.hasDocSchedule=docId})};$scope.chooseSchedule=function(docId,name){$scope.order.doctorId=docId,$scope.order.doctorName=name,queryDoctorSchedule(docId),$scope.selectDoc=docId};var selected={index:0,obj:{timeList:[]}};$scope.chooseTime=function(index,obj){(selected.obj!==obj||selected.obj===obj&&selected.index!==index)&&(selected.obj.timeList.length>0&&ToolService.select(selected.index,selected.obj.timeList,!0),selected.index=index,selected.obj=obj,ToolService.select(selected.index,selected.obj.timeList),$scope.order.scheduleId=obj.timeList[index].scheduleid,$scope.order.treatmentTime=obj.timeList[index].date,$scope.mergeDocSelect($scope.selectDoc,obj.timeList[index].date),$scope.selectTime=!1,$scope.noSelectTime=!1)},$scope.orderDetail=function(){if(!$scope.noSelectTime)if(ToolService.checkLogin())if(ToolService.infoComplete()){ToolService.loadUser();var params={productId:$scope.order.productId};$scope.order.code&&(params.code=$scope.order.code),$scope.order.discountid&&(params.discountid=$scope.order.discountid),AjaxService.post({url:ToolService.host+"/wx/order/checkCodeMoney",data:params,headers:{accessToken:ToolService.user.accessToken}}).then(function(data){$scope.order.dealMoney=data.dealMoney,$scope.order.payMoney=data.payMoney,$scope.order.realMoney=data.realMoney,$scope.order.giftMoney=data.giftMoney,parseFloat($scope.order.giftMoney)<=0&&11!=$scope.order.flag&&($scope.order.flag=null),ToolService.setSession("makeorder",$scope.order),ToolService.changeRoute("/makeorder")})}else ToolService.comfirm("请完善个人信息!",function(){$rootScope.messageTip.has=!1,ToolService.changeRoute("/user/userinfo")});else ToolService.comfirm("请先登录并完善个人信息",function(){$rootScope.messageTip.has=!1,ToolService.changeRoute("/login")})},$scope.mergeProdcut=function(data){null!=data.priceunit&&""!=data.priceunit?data.preferPriceType=data.pricetype+"/"+data.priceunit:data.preferPriceType=data.pricetype,$location.search().money&&(data.preferPrice=$location.search().money)},$scope.mergeSchedule=function(items){for(var Itemindex=0;Itemindex<items.length;Itemindex++)for(var item=items[Itemindex],Timeindex=0;Timeindex<item.length;Timeindex++){var time=item.timeList[Timeindex];0==Itemindex&&0==Timeindex?$scope.scheduleParams[time.scheduleid]={has:!0,value:time.date}:$scope.scheduleParams[time.scheduleid]={has:!1,value:time.date}}},$scope.mergeDocSelect=function(docId,value){$scope.doctorInfo.forEach(function(item){item.id==docId?(item.selectTimeValue=value,item.hasSelecTimeValue=!0):(item.selectTimeValue="请选择",item.hasSelecTimeValue=!1)})},$scope.switchFollow=function(){ToolService.checkLogin()?(ToolService.loadUser(),$scope.follow.hasFollow?$scope.cacelFollow():$scope.tofollow()):ToolService.comfirm("请先登录!",function(){$rootScope.messageTip.has=!1,ToolService.changeRoute("/login")})},$scope.tofollow=function(){AjaxService.post({url:ToolService.host+"/wx/post/focus",data:{flag:3,userId:$scope.proId},headers:{accessToken:ToolService.user.accessToken}}).then(function(data){0==data.code?($scope.follow.hasFollow=!0,$scope.follow.followText="已关注"):ToolService.alert("关注失败，稍后再试!")})},$scope.cacelFollow=function(){AjaxService.post({url:ToolService.host+"/wx/post/cacelFocus",data:{flag:3,userId:$scope.proId},headers:{accessToken:ToolService.user.accessToken}}).then(function(data){0==data.code?($scope.follow.hasFollow=!1,$scope.follow.followText="关注"):ToolService.alert("取消关注失败，稍后再试!")})},ToolService.reset(),$rootScope.globalProp.hasBgColor=!0,loadQueryParams(),$scope.order.hospitalId=$scope.hosId,$scope.order.productId=$scope.proId,queryProduct(),queryProductImg(),queryHospitalImg(),queryDoctor(),queryHospital()}return productDetail});