define(["require","exports","angular","Swiper","WX","./modules/Tool","./modules/Ajax","./modules/Weixin"],function(require,exports,ag,Swiper,wx,Tool,Ajax,Weixin){"use strict";var host="http://192.168.0.102:3000",app=ag.module("myApp",["ngRoute"]);return app.run(function($rootScope,$location,$http){$http.defaults.headers.post={"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},$rootScope.navMenu={home:!1,doctor:!1,interaction:!1,user:!1,has:!1},$rootScope.load={has:!1,src:"../../contents/img/loading.gif",val:"加载中..."},$rootScope.messageTip={has:!1,message:"",hasCancel:!1,hasComfirm:!1,comfirm:null,cancel:null},$rootScope.followTip={has:!1,val:"",empty:"暂无信息",no:"已经没有了"},$rootScope.globalProp={hasBgColor:!1,hasBlackBg:!1},$rootScope.switchNavMenu=function(item){"/home"===item?$rootScope.navMenu.home||($rootScope.navMenu.home=!0,$rootScope.navMenu.doctor=!1,$rootScope.navMenu.interaction=!1,$rootScope.navMenu.user=!1,$rootScope.navMenu.has=!0):"/doctor"===item?$rootScope.navMenu.doctor||($rootScope.navMenu.doctor=!0,$rootScope.navMenu.home=!1,$rootScope.navMenu.interaction=!1,$rootScope.navMenu.user=!1,$rootScope.navMenu.has=!0):"/interaction"===item?$rootScope.navMenu.interaction||($rootScope.navMenu.interaction=!0,$rootScope.navMenu.home=!1,$rootScope.navMenu.doctor=!1,$rootScope.navMenu.user=!1,$rootScope.navMenu.has=!0):"/user"===item?$rootScope.navMenu.user||($rootScope.navMenu.user=!0,$rootScope.navMenu.home=!1,$rootScope.navMenu.doctor=!1,$rootScope.navMenu.interaction=!1,$rootScope.navMenu.has=!0):($rootScope.navMenu.home=!1,$rootScope.navMenu.doctor=!1,$rootScope.navMenu.interaction=!1,$rootScope.navMenu.user=!1,$rootScope.navMenu.has=!1)},$rootScope.$on("$routeChangeStart",function(){$rootScope.load.has=!0;var path=$location.path();$rootScope.switchNavMenu(path)}),$rootScope.$on("$routeChangeSuccess",function(){$rootScope.load.has=!1}),$rootScope.menuClick=function(path){$location.path(path)},$rootScope.changeRoute=function(path,query){$location.path(path),query?$location.search(query):$location.search("")}}),app.config(function($routeProvider,$controllerProvider){$routeProvider.when("/home",{templateUrl:"home.html",controller:"homeCtrl"}).when("/doctor",{templateUrl:"doctor.html",controller:"doctorCtrl"}).when("/interaction",{templateUrl:"interaction.html",controller:"interactionCtrl"}).when("/user",{templateUrl:"user.html",controller:"userCtrl"}).when("/doctor/detail",{templateUrl:"doctordetail.html",controller:"doctorDetailCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/doctorDetail.js",name:"doctorDetailCtrl"},$controllerProvider)}).when("/doctor/askDoctor",{templateUrl:"askdoctor.html",controller:"askDoctorCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/askDoctor.js",name:"askDoctorCtrl"},$controllerProvider)}).when("/interaction/detail",{templateUrl:"interactiondetail.html",controller:"interactionDetailCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/interactionDetail.js",name:"interactionDetailCtrl"},$controllerProvider)}).when("/user/userinfo",{templateUrl:"userinfo.html",controller:"userInfoCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/userinfo.js",name:"userInfoCtrl"},$controllerProvider)}).when("/user/cush",{templateUrl:"cush.html",controller:"cushCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/cush.js",name:"cushCtrl"},$controllerProvider)}).when("/user/cush/read",{templateUrl:"cushreadme.html",controller:"cushCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/cush.js",name:"cushCtrl"},$controllerProvider)}).when("/user/cushover",{templateUrl:"cushover.html",controller:"cushOverCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/cushOver.js",name:"cushOverCtrl"},$controllerProvider)}).when("/user/userinfochange",{templateUrl:"userinfochange.html",controller:"userInfoChangeCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/userInfoChange.js",name:"userInfoChangeCtrl"},$controllerProvider)}).when("/user/order",{templateUrl:"order.html",controller:"userOrderCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/order.js",name:"userOrderCtrl"},$controllerProvider)}).when("/activity",{templateUrl:"activity.html",controller:"activityCtrl",resolve:Tool.loadCtrl({url:"../../../javascripts/dest/controller/activity.js",name:"activityCtrl"},$controllerProvider)}).when("/product/detail",{templateUrl:"productdetail.html",controller:"productDetailCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/productDetail.js",name:"productDetailCtrl"},$controllerProvider)}).when("/product",{templateUrl:"product.html",controller:"productCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/product.js",name:"productCtrl"},$controllerProvider)}).when("/exam/detail",{templateUrl:"examdetail.html",controller:"examDetailCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/examDetail.js",name:"examDetailCtrl"},$controllerProvider)}).when("/discount",{templateUrl:"discount.html",controller:"discountCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/discount.js",name:"discountCtrl"},$controllerProvider)}).when("/findpwd/phone",{templateUrl:"findpwdphone.html",controller:"findPassCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/findPass.js",name:"findPassCtrl"},$controllerProvider)}).when("/findpwd/code",{templateUrl:"findpwdcode.html",controller:"findPassCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/findPass.js",name:"findPassCtrl"},$controllerProvider)}).when("/findpwd/pwd",{templateUrl:"findpwdpwd.html",controller:"findPassCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/findPass.js",name:"findPassCtrl"},$controllerProvider)}).when("/grab",{templateUrl:"grab.html",controller:"grabCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/grab.js",name:"grabCtrl"},$controllerProvider)}).when("/grab/code",{templateUrl:"grabcode.html",controller:"grabCodeCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/grabCode.js",name:"grabCodeCtrl"},$controllerProvider)}).when("/grab/order",{templateUrl:"graborder.html",controller:"grabOrderCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/grabOrder.js",name:"grabOrderCtrl"},$controllerProvider)}).when("/login",{templateUrl:"login.html",controller:"loginCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/login.js",name:"loginCtrl"},$controllerProvider)}).when("/makeorder",{templateUrl:"makeorder.html",controller:"makeOrderCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/makeorder.js",name:"makeOrderCtrl"},$controllerProvider)}).when("/news",{templateUrl:"news.html",controller:"newsCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/news.js",name:"newsCtrl"},$controllerProvider)}).when("/news/detail",{templateUrl:"newsdetail.html",controller:"newsCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/news.js",name:"newsCtrl"},$controllerProvider)}).when("/order",{templateUrl:"order.html",controller:"orderCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/order.js",name:"orderCtrl"},$controllerProvider)}).when("/pay",{templateUrl:"pay.html",controller:"payCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/pay.js",name:"payCtrl"},$controllerProvider)}).when("/pay/result",{templateUrl:"payresult.html",controller:"payResultCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/payResult.js",name:"payResultCtrl"},$controllerProvider)}).when("/register",{templateUrl:"register.html",controller:"registerCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/register.js",name:"registerCtrl"},$controllerProvider)}).when("/agreement",{templateUrl:"agreement.html"}).when("/write",{templateUrl:"write.html",controller:"writeCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/write.js",name:"writeCtrl"},$controllerProvider)}).when("/write/say",{templateUrl:"writesay.html",controller:"writeCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/write.js",name:"writeCtrl"},$controllerProvider)}).when("/write/note",{templateUrl:"writenote.html",controller:"writeCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/write.js",name:"writeCtrl"},$controllerProvider)}).when("/user/mypost",{templateUrl:"mypost.html",controller:"myPostCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/myPost.js",name:"myPostCtrl"},$controllerProvider)}).when("/user/mymessage",{templateUrl:"mymessage.html",controller:"myMessageCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/myMessage.js",name:"myMessageCtrl"},$controllerProvider)}).when("/user/myfollow",{templateUrl:"myfollow.html",controller:"myFollowCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/myFollow.js",name:"myFollowCtrl"},$controllerProvider)}).when("/exam",{templateUrl:"exam.html",controller:"examCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/exam.js",name:"examCtrl"},$controllerProvider)}).when("/invite/new",{templateUrl:"invitenew.html",controller:"inviteCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/invite.js",name:"inviteCtrl"},$controllerProvider)}).when("/invite/register",{templateUrl:"inviteregister.html",controller:"inviteCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/invite.js",name:"inviteCtrl"},$controllerProvider)}).when("/invite/notes",{templateUrl:"invitenotes.html",controller:"inviteNotesCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/inviteNotes.js",name:"inviteNotesCtrl"},$controllerProvider)}).when("/user/paymoney",{templateUrl:"paymoney.html",controller:"payMoneyCtrl",resolve:Tool.loadCtrl({url:"../../javascripts/dest/controller/payMoney.js",name:"payMoneyCtrl"},$controllerProvider)}).otherwise({redirectTo:"/home"})}),app.factory("ToolService",function($rootScope,$location){return new Tool($rootScope,$location,host)}),app.factory("AjaxService",function($rootScope,$http,$q,ToolService){return new Ajax($rootScope,$http,$q,ToolService)}),app.factory("WeixinService",function($rootScope,AjaxService,ToolService){return new Weixin($rootScope,AjaxService,ToolService,wx)}),app.directive("fallbackSrc",function(){return{restrict:"A",link:function(scope,iElement,iAttr){iElement.bind("error",function(){iElement.attr("src",iAttr.fallbackSrc)})}}}),app.directive("productError",function(){return{restrict:"A",link:function($scope,iElement,iAttr){iElement.bind("error",function(){iElement.attr("src","../contents/img/p_default.png")})}}}),app.directive("doctorError",function(){return{restrict:"A",link:function($scope,iElement,iAttr){iElement.bind("error",function(){iElement.attr("src","../contents/img/doc-head.png")})}}}),app.directive("userError",function(){return{restrict:"A",link:function($scope,iElement,iAttr){iElement.bind("error",function(){var imgUrl="../contents/img/men-head.png";iAttr.userError&&"女"===iAttr.userError&&(imgUrl="../contents/img/women-head.png"),iElement.attr("src",imgUrl)})}}}),app.directive("zoomImage",function(){return{restrict:"A",link:function($scope,iElement,iAttr){var containSize=parseInt(iElement.css("width").slice(0,-2));iElement.css("height",containSize);var children=iElement.children();children.bind("load",function(){var width=parseInt(children.css("width").slice(0,-2)),height=parseInt(children.css("height").slice(0,-2));if(width>height){var zWidth=containSize/height*width,zHeight=containSize;children.css("marginLeft",-(zWidth-containSize)/2)}else{var zHeight=containSize/width*height,zWidth=containSize;children.css("marginTop",-(zHeight-containSize)/2)}children.css("width",zWidth),children.css("height",zHeight)})}}}),app.filter("defaultHeadImg",function(){return function(input,sex){return input=null===input||""===input?"../contents/img/men-head.png":"../contents/img/women-head.png"}}),app.filter("defaultImg",function(){return function(input,type){return null!==input&&""!==input||("doc"===type&&(input="../contents/img/doc-head.png"),"pro"===type&&(input="../contents/img/p_default.png")),input}}),app.controller("homeCtrl",function($scope,$rootScope,$http,ToolService,AjaxService,WeixinService){$scope.locationInfo="深圳市",$scope.items=[],$scope.banners=[],$scope.imgStyle={width:screen.width},$scope.getLocation=function(latitude,longitude){var key="LFQBZ-7UNCX-VDR44-T34PN-OX2VQ-M2BNI",url="https://apis.map.qq.com/ws/geocoder/v1/?output=jsonp&callback=JSON_CALLBACK&location="+latitude+","+longitude+"&key="+key;$http.jsonp(url).success(function(data){if(0==data.status){$scope.locationInfo=data.result.address_component.city;var locationInfo=ToolService.getSession("locationInfo");locationInfo.city=data.result.address_component.city,ToolService.setSession("locationInfo",locationInfo)}else $scope.locationInfo="定位失败"}).error(function(){$scope.locationInfo="定位失败"})};var queryParams={city:"深圳",currentPage:1},loadRecommend=function(){AjaxService.post({url:ToolService.host+"/wx/product/queryrecommend",data:queryParams}).then(function(data){0===data.code&&(data.data.length<1?($scope.items.length<1?$rootScope.followTip.val=$rootScope.followTip.empty:$rootScope.followTip.val=$rootScope.followTip.no,$rootScope.followTip.has=!0):(mergeProduct(data.data),$scope.items=$scope.items.concat(data.data)))})},queryBanners=function(){AjaxService.post({url:ToolService.host+"/wx/banner/query",data:{type:"home_banner"}}).then(function(data){0==data.code&&($scope.banners=data.data)})},loadNext=function(){queryParams.currentPage++,loadRecommend()},initSwiper=function(){new Swiper(".swiper-container",{loop:!1,pagination:".swiper-pagination",autoplay:2e3,autoplayDisableOnInteraction:!1,observeParents:!0,observer:!0,onSlideChangeEnd:function(swiper){0==swiper.activeIndex||1==swiper.activeIndex?(swiper.stopAutoplay(),setTimeout(function(){0!=swiper.activeIndex&&1!=swiper.activeIndex||swiper.startAutoplay()},4e3)):swiper.startAutoplay()}})},mergeProduct=function(items){items.forEach(function(item){null!=item.priceunit&&""!=item.priceunit?item.preferPriceType=item.pricetype+"/"+item.priceunit:item.preferPriceType=item.pricetype})};$scope.detail=function(productId,hospitalId,type){5===type?ToolService.changeRoute("/exam/detail","productId="+productId+"&hospitalId="+hospitalId):ToolService.changeRoute("/product/detail","flag=1&productId="+productId+"&hospitalId="+hospitalId)},$scope.activity=function(id){1===id&&ToolService.changeRoute("/activity","flag=2"),2===id&&ToolService.changeRoute("/invite/new"),3===id&&ToolService.changeRoute("/activity","flag=1")},$rootScope.followTip.has=!1,$rootScope.followTip.val="",$rootScope.globalProp.hasBgColor=!1,loadRecommend(),queryBanners(),initSwiper(),ToolService.onWindowListen(loadNext),!ToolService.getSession("locationInfo")||!ToolService.getSession("locationInfo").has}),app.controller("doctorCtrl",function($scope,$rootScope,$http,ToolService,AjaxService){$scope.doctors=[],$scope.orderParams=ToolService.doctorOrderParams,$scope.areaParams=ToolService.areaParams,$scope.professionalParams=ToolService.professionalParams,$scope.menuParams=[{has:!1,val:"专科"},{has:!1,val:"区域"},{has:!1,val:"排序"}];var queryParams={professionId:"",itemid:"",orderby:"",city:"深圳",area:"",pageRows:10,currentPage:1},queryDoctor=function(){AjaxService.post({url:ToolService.host+"/wx/doctor/querydoctorbycityandprofession",data:queryParams}).then(function(data){data.data.length<1?($scope.doctors.length<1?$rootScope.followTip.val=$rootScope.followTip.empty:$rootScope.followTip.val=$rootScope.followTip.no,$rootScope.followTip.has=!0):(mergeDoctor(data.data),$scope.doctors=$scope.doctors.concat(data.data))})},mergeDoctor=function(items){items.forEach(function(item){""!=item.score&&null!=item.score||(item.score="暂无评"),""!=item.sales&&null!=item.sales||(item.sales=0)})};$scope.switchNav=function(index,obj){ToolService.select(index,obj,!0),$rootScope.globalProp.hasBlackBg=obj[index].has},$scope.switchDrop=function(index,obj){ToolService.select(index,obj),obj===$scope.areaParams?($scope.menuParams[1].has=!1,queryParams.area=$scope.areaParams[index].id):obj===$scope.doctorOrderParams&&($scope.menuParams[2].has=!1,queryParams.orderby=$scope.doctorOrderParams[index].id),$rootScope.followTip.has=!1,$scope.doctors=[],queryParams.currentPage=1,queryDoctor(),$rootScope.globalProp.hasBlackBg=!1},$scope.switchLevelOne=function(index,obj){ToolService.select(index,obj,!0)};var selected={index:0,obj:$scope.professionalParams[0]};$scope.switchLevelTwo=function(index,obj){(selected.obj!==obj||selected.obj===obj&&selected.index!=index)&&(ToolService.select(selected.index,selected.obj.children,!0),selected.index=index,selected.obj=obj,ToolService.select(index,obj.children),$scope.menuParams[0].has=!1,queryParams.professionId=obj.id,queryParams.itemid=obj.children[index].id,$rootScope.followTip.has=!1,$scope.doctors=[],queryParams.currentPage=1,queryDoctor(),$rootScope.globalProp.hasBlackBg=!1)};var loadNext=function(){queryParams.currentPage++,queryDoctor()};$scope.detail=function(id){ToolService.changeRoute("/doctor/detail","id="+id)},ToolService.reset(),ToolService.areaParams[0].has=!0,ToolService.doctorOrderParams[0].has=!0,ToolService.professionalParams[0].has=!0,ToolService.professionalParams[0].children[0].has=!0,ToolService.onWindowListen(loadNext),queryDoctor()}),app.controller("interactionCtrl",function($scope,$rootScope,ToolService,AjaxService){var queryParams={flag:1,pageRows:10,currentPage:1};$scope.navParams=[{has:!0,val:"看牙",id:1},{has:!1,val:"求美",id:2},{has:!1,val:"孕·生",id:3}],$scope.posts=[];var queryPost=function(){AjaxService.post({url:ToolService.host+"/wx/post/postList",data:queryParams}).then(function(data){data.data.length<1?($scope.posts.length<1?$rootScope.followTip.val=$rootScope.followTip.empty:$rootScope.followTip.val=$rootScope.followTip.no,$rootScope.followTip.has=!0):(mergePost(data.data),$scope.posts=$scope.posts.concat(data.data))})},mergePost=function(items){items.forEach(function(item){null!=item.visitNum&&""!=item.visitNum||(item.visitNum=0),""!=item.commentNum&&null!=item.commentNum||(item.commentNum=0),null===item.faceImage&&""===item.faceImage||(item.faceImage="https://biz.uokang.com/"+item.faceImage);for(var index in item.list2)""!=item.list2[index]&&null!=item.list2[index]||item.list2.splice(index,1)})};$scope.switchType=function(index){queryParams.flag=$scope.navParams[index].id,queryParams.currentPage=1,ToolService.select(index,$scope.navParams),$rootScope.followTip.has=!1,$scope.posts=[],queryPost()},$scope.detail=function(id){ToolService.changeRoute("/interaction/detail","id="+id)};var loadNext=function(){queryParams.currentPage++,queryPost()};$rootScope.followTip.has=!1,$rootScope.followTip.val="",ToolService.onWindowListen(loadNext),queryPost()}),app.controller("userCtrl",function($scope,$rootScope,$location,ToolService,AjaxService){$scope.user={},$scope.isLogin=!1,$scope.countFocusMan=0,$scope.countFansMan=0;var init=function(){ToolService.checkLogin()?(ToolService.loadUser(),$scope.user=ToolService.user,$scope.isLogin=!0,ToolService.empty($scope.user.nickname)&&($scope.user.nickname="还没有填写昵称")):($scope.user.face="../contents/img/men-head.png",$scope.user.tip="点击登录/注册")};$scope.alert=function(mess){ToolService.alert(mess)};var queryFocus=function(){AjaxService.post({url:ToolService.host+"/wx/focus/focusManCount",data:{accessToken:ToolService.user.accessToken}}).then(function(data){0==data.code&&(ToolService.empty(data.data.countFocusMan)||($scope.countFocusMan=data.data.countFocusMan),ToolService.empty(data.data.countFansMan)||($scope.countFansMan=data.data.countFansMan))})};$scope["goto"]=function(path,query){ToolService.checkLogin()?ToolService.changeRoute(path,query):ToolService.changeRoute("/login","")},$rootScope.globalProp.hasBgColor=!0,ToolService.cancelWindowListen(),init(),ToolService.checkLogin()&&(ToolService.loadUser(),queryFocus())}),app});