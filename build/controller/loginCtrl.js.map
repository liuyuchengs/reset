{"version":3,"sources":["controller/loginCtrl.ts"],"names":[],"mappings":";;;;;;;;;AAAA,kDAAkD;AAClD,MAAO,UAAU,WAAW,yBAAyB,CAAC,CAAC;AACvD,MAAO,YAAY,WAAW,2BAA2B,CAAC,CAAC;AAC3D,MAAO,IAAI,WAAW,mBAAmB,CAAC,CAAC;AAE3C;;;GAGG;AAEH;;;;GAIG;AACH,eAAsB,MAAU;IAC5B,EAAE,CAAA,CAAC,MAAM,CAAC,KAAK,IAAE,MAAM,CAAC,QAAQ,CAAC,CAAA,CAAC;QAC9B,EAAE,CAAA,CAAC,qBAAqB,CAAC,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,IAAE,MAAM,CAAC,QAAQ,CAAC,MAAM,IAAE,CAAC,IAAE,MAAM,CAAC,QAAQ,CAAC,MAAM,IAAE,EAAE,CAAC,CAAA,CAAC;YAChG,MAAM,CAAC,IAAI,CAAC;QAChB,CAAC;QAAA,IAAI,CAAA,CAAC;YACF,MAAM,CAAC,KAAK,CAAC;QACjB,CAAC;IACL,CAAC;IAAA,IAAI,CAAA,CAAC;QACF,MAAM,CAAC,KAAK,CAAC;IACjB,CAAC;AACL,CAAC;AAVe,aAAK,QAUpB,CAAA;AACD;;;;GAIG;AACH,eAA4B,MAAU;;QAClC,IAAI,MAAiB,CAAC;QACtB,IAAI,SAAa,CAAC;QAClB,IAAI,GAAG,GAAG,mDAAmD,GAAC,MAAM,CAAC,KAAK,GAAC,uEAAuE,CAAC;QACnJ,IAAG,CAAC;YACA,SAAS,GAAG,MAAM,YAAY,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;YAC1C,MAAM,CAAC,IAAI,OAAO,CAAa,CAAC,OAAgC;gBAC5D,EAAE,CAAA,CAAC,SAAS,CAAC,MAAM,GAAC,CAAC,IAAE,SAAS,CAAC,CAAC,CAAC,CAAC,QAAQ,KAAG,MAAM,CAAC,QAAQ,CAAC,CAAA,CAAC;oBAC5D,IAAI,SAAS,GAAG,IAAI,CAAC,YAAY,CAAC,CAAC,IAAI,EAAC,UAAU,EAAC,OAAO,EAAC,MAAM,EAAC,KAAK,EAAC,UAAU,EAAC,OAAO,EAAC,WAAW,EAAC,QAAQ,EAAC,OAAO,EAAC,cAAc,EAAC,cAAc,CAAC,EAAC,SAAS,CAAC,CAAC,CAAC,CAAC,CAAC;oBACrK,SAAS,CAAC,aAAa,CAAC,GAAG,SAAS,CAAC,cAAc,CAAC,CAAC;oBACrD,OAAO,SAAS,CAAC,cAAc,CAAC,CAAC;oBACjC,MAAM,GAAG,UAAU,CAAC,YAAY,CAAC,SAAS,EAAC,CAAC,EAAC,OAAO,CAAC,CAAC;gBAC1D,CAAC;gBAAA,IAAI,CAAA,CAAC;oBACF,MAAM,GAAG,UAAU,CAAC,gBAAgB,CAAC,YAAY,CAAC,CAAC;gBACvD,CAAC;gBACD,OAAO,CAAC,MAAM,CAAC,CAAC;YACpB,CAAC,CAAC,CAAA;QACN,CAAC;QAAA,KAAK,CAAA,CAAC,GAAG,CAAC,CAAA,CAAC;YACR,OAAO,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;YACjB,MAAM,CAAC,IAAI,OAAO,CAAa,CAAC,MAAwB;gBACpD,MAAM,CAAC,GAAG,CAAC,CAAC;YAChB,CAAC,CAAC,CAAA;QACN,CAAC;IACL,CAAC;;AAvBqB,aAAK,QAuB1B,CAAA","file":"controller/loginCtrl.js","sourcesContent":["/// <reference path=\"./../../typings/index.d.ts\"/>\nimport HttpResult = require(\"./../modules/HttpResult\");\nimport MysqlConnect = require(\"./../modules/MysqlConnect\");\nimport Tool = require(\"./../modules/Tool\");\n\n/**\n * 登录相关模块\n * @module\n */\n\n/**\n * 检查账号密码是否符合要求\n * @param {any} params - 经过express parser转换的req.body,需要phone和password字段\n * @returns {boolean} 是否符合要求\n */\nexport function check(params:any){\n    if(params.phone&&params.password){\n        if(/^1[3|4|5|7|8]\\d{9}$/.test(params.phone)&&params.password.length>=8&&params.password.length<=20){\n            return true;\n        }else{\n            return false;\n        }\n    }else{\n        return false;\n    }\n}\n/**\n * 登录操作\n * @param {any} params - 经过express parser转换的req.body,需要phone和password字段\n * @returns {HttpResult} 返回登录结果,异常时返回error异常对象\n */\nexport async function login(params:any):Promise<HttpResult>{\n    let result:HttpResult;\n    let sqlResult:any;\n    let sql = \"select * from (select * from user where phone = '\"+params.phone+\"') as users left join user_token as token on users.id = token.user_id\";\n    try{\n        sqlResult = await MysqlConnect.query(sql);\n        return new Promise<HttpResult>((resolve:(value:HttpResult)=>void)=>{\n            if(sqlResult.length>0&&sqlResult[0].password===params.password){\n                let resResult = Tool.FilterResult([\"id\",\"nickname\",\"phone\",\"face\",\"sex\",\"realname\",\"email\",\"gift_code\",\"alipay\",\"wxpay\",\"referralCode\",\"access_token\"],sqlResult[0]);\n                resResult[\"accessToken\"] = resResult[\"access_token\"];\n                delete resResult[\"access_token\"];\n                result = HttpResult.CreateResult(resResult,0,\"登录成功!\");\n            }else{\n                result = HttpResult.CreateFailResult(\"账号或者密码不正确!\");\n            }\n            resolve(result);\n        })\n    }catch(err){\n        console.log(err);\n        return new Promise<HttpResult>((reject:(value:any)=>void)=>{\n            reject(err);\n        })\n    }\n}\n\n"],"sourceRoot":"../src"}